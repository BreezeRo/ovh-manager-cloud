{"remainingRequest":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/@ovh-ux/manager-webpack-config/loaders/ui-router-translations.js??ref--11-1!/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/client/app/nasha/partition/access/nasha-partition-access.controller.js","dependencies":[{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/client/app/nasha/partition/access/nasha-partition-access.controller.js","mtime":1539717142241},{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/cache-loader/dist/cjs.js","mtime":1539679504371},{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/babel-loader/lib/index.js","mtime":1539597349061},{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/cache-loader/dist/cjs.js","mtime":1539679504371},{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/@ovh-ux/manager-webpack-config/loaders/ui-router-translations.js","mtime":1539950864368}],"contextDependencies":[],"result":["angular.module('managerApp').controller('NashaPartitionAccessCtrl', function ($scope, $state, $stateParams, $translate, $uibModal, $q, OvhApiDedicatedNasha, Poller, CloudMessage) {\n  const self = this;\n\n  self.$state = $state;\n\n  self.data = {\n    nasha: {},\n    partition: {},\n    addAccessInProgress: [],\n    taskForAccess: [],\n  };\n\n  self.table = {\n    accessIps: [],\n    refresh: false,\n  };\n\n  self.loaders = {\n    table: false,\n  };\n\n  self.load = function (resetCache) {\n    self.loaders.table = true;\n    if (resetCache) {\n      OvhApiDedicatedNasha.Partition().Access().v6().resetCache();\n    }\n    $q.all({\n      nasha: OvhApiDedicatedNasha.v6().get({ serviceName: $stateParams.nashaId }).$promise,\n      partition: OvhApiDedicatedNasha.Partition().v6()\n        .get({\n          serviceName: $stateParams.nashaId,\n          partitionName: $stateParams.partitionName,\n        }).$promise,\n      accesses: OvhApiDedicatedNasha.Partition().Access().v6()\n        .query({\n          serviceName: $stateParams.nashaId,\n          partitionName: $stateParams.partitionName,\n        }).$promise,\n    }).then((data) => {\n      self.data.nasha = data.nasha;\n      self.data.partition = data.partition;\n      self.table.accessIps = data.accesses.map(ip => ({\n        ip,\n      }));\n      if (resetCache) {\n        self.table.refresh = !self.table.refresh;\n      }\n    }).catch((err) => {\n      CloudMessage.error($translate.instant('nasha_partitions_access_no_data_error'));\n      return $q.reject(err);\n    }).finally(() => {\n      self.loaders.table = false;\n    });\n  };\n\n  self.getAccessForIp = function (accessIp) {\n    // If the access is being added, return the local data\n    const accessAddInProgress = _.find(self.data.addAccessInProgress, item => item.ip === accessIp);\n    if (accessAddInProgress) {\n      return accessAddInProgress;\n    }\n\n    // if not we get the details form the api\n    return OvhApiDedicatedNasha.Partition().Access().v6().get({\n      serviceName: self.data.nasha.serviceName,\n      partitionName: self.data.partition.partitionName,\n      ip: accessIp,\n    }).$promise.then(data => data);\n  };\n\n  self.transformItem = function (access) {\n    return self.getAccessForIp(access.ip);\n  };\n\n  self.removeAccess = function (access) {\n    self.openModal('app/nasha/partition/access/delete/nasha-partition-access-delete.html', 'NashaPartitionAccessDeleteCtrl', {\n      serviceName: self.data.nasha.serviceName,\n      access,\n      partitionName: self.data.partition.partitionName,\n    });\n  };\n\n  self.addAccess = function () {\n    self.openModal('app/nasha/partition/access/add/nasha-partition-access-add.html', 'NashaPartitionAccessAddCtrl', {\n      serviceName: self.data.nasha.serviceName,\n      partition: self.data.partition,\n    });\n  };\n\n  /*= =====================================\n     =                Polling              =\n     ====================================== */\n\n  function launchPolling(taskId) {\n    return Poller.poll(`/dedicated/nasha/${self.data.nasha.serviceName}/task/${taskId}`,\n      null,\n      {\n        successRule(task) {\n          return task.status === 'done';\n        },\n        errorRule(task) {\n          return ['doing', 'todo', 'done'].indexOf(task.status) === -1;\n        },\n        namespace: 'nasha.access',\n      });\n  }\n\n  function pollTasksForAccess(access, taskId) {\n    launchPolling(taskId)\n      .finally(() => {\n        // Remove from the polling list\n        _.remove(self.data.taskForAccess, item => item.task === taskId);\n\n        // If the partition was in creation, remove it from the creation list\n        _.remove(self.data.addAccessInProgress, item => item.ip === access.ip);\n\n        self.updateAccess(access);\n      });\n  }\n\n  $scope.$on('$destroy', () => {\n    Poller.kill({ namespace: 'nasha.access' });\n  });\n\n  self.openModal = function (template, controller, params) {\n    const modal = $uibModal.open({\n      templateUrl: template,\n      controller,\n      controllerAs: controller,\n      resolve: {\n        items() {\n          return params;\n        },\n      },\n    });\n\n    modal.result.then((data) => {\n      if (data.isNew) {\n        self.table.accessIps.push(data.access);\n        self.data.addAccessInProgress.push(data.access);\n      }\n      self.data.taskForAccess.push({ task: data.task, access: data.access });\n      pollTasksForAccess(data.access, data.task);\n    });\n  };\n\n  self.updateAccess = function () {\n    self.load(true);\n  };\n\n  self.hasTaskInProgress = function (access) {\n    return _.some(self.data.taskForAccess, { access });\n  };\n\n  self.load();\n});\n"]}