{"remainingRequest":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/@ovh-ux/manager-webpack-config/loaders/ui-router-translations.js??ref--11-1!/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/client/components/ovh-task-alert/ovh-task-alert.service.js","dependencies":[{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/client/components/ovh-task-alert/ovh-task-alert.service.js","mtime":1539717142410},{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/cache-loader/dist/cjs.js","mtime":1539679504371},{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/babel-loader/lib/index.js","mtime":1539597349061},{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/cache-loader/dist/cjs.js","mtime":1539679504371},{"path":"/Users/jleveugle/Documents/Work/github/ovh-ux/ovh-manager-cloud/node_modules/@ovh-ux/manager-webpack-config/loaders/ui-router-translations.js","mtime":1539950864368}],"contextDependencies":[],"result":["class OvhTaskAlertsService {\n  constructor($translate, ControllerHelper, CloudMessage, OvhApiMeAlertsAapi, $http,\n    TranslateService) {\n    this.$translate = $translate;\n    this.$http = $http;\n    this.ControllerHelper = ControllerHelper;\n    this.CloudMessage = CloudMessage;\n    this.UserAlertsAapi = OvhApiMeAlertsAapi;\n    this.TranslateService = TranslateService;\n  }\n\n  getTaskInfo() {\n    return this.$http.get('/ovh-tasks', {\n      serviceType: 'aapi',\n    }).then((response) => {\n      if (response.data.alerts.length) {\n        _.forEach(response.data.alerts, (alert) => {\n          const tasks = _.map(_.get(response, 'data.tasks', []), (task) => {\n            _.set(task, 'comments', _.map(task.comments, (comment) => {\n              _.set(comment, 'comment_text', _.get(comment, 'comment_text', '').replace(/\\\\'/g, \"'\").replace(/\\\\\"/g, '\"'));\n              return comment;\n            }).reverse());\n            _.set(task, 'detailed_desc', _.get(task, 'detailed_desc', '').replace(/\\\\'/g, \"'\").replace(/\\\\\"/g, '\"'));\n            return task;\n          });\n          this.sendAlert(alert, tasks);\n        });\n        return response.data;\n      }\n      return {};\n    });\n  }\n\n  sendAlert(alert, tasks) {\n    const language = this.TranslateService.getGeneralLanguage();\n    const locale = language === 'en' ? 'en_GB' : 'fr_FR';\n    const text = alert[locale];\n    const message = {\n      textHtml: text,\n    };\n    if (tasks.length) {\n      message.link = {\n        type: 'action',\n        action: () => this.showSubTasks(tasks),\n        text: this.$translate.instant('ovh_task_follow_button'),\n      };\n    }\n    return this.CloudMessage.warning(message, 'index');\n  }\n\n  getOvhTaskAlerts() {\n    return this.$translate.refresh().then(() => this.getTaskInfo());\n  }\n\n  showSubTasks(tasks) {\n    this.ControllerHelper.modal.showModal({\n      modalConfig: {\n        templateUrl: 'components/ovh-task-alert/modal/ovh-task-follow-modal.html',\n        controller: 'ovhTaskFollowModalCtrl',\n        controllerAs: '$ctrl',\n        resolve: {\n          tasks: () => tasks,\n        },\n      },\n    });\n  }\n}\n\nangular.module('managerApp').service('OvhTaskAlertsService', OvhTaskAlertsService);\n"]}